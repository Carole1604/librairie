<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tableau de Bord - Statistiques</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> Tableau de Bord - Statistiques</h2>
        <div>
            <a href="/tableau_de_bord/mois" class="btn btn-outline-info me-2">
                <i class="bi bi-calendar-month"></i> Vue mensuelle
            </a>
            <a href="/tableau_de_bord/historique" class="btn btn-outline-secondary me-2">
                <i class="bi bi-clock-history"></i> Historique
            </a>
            <a href="/" class="btn btn-secondary">
                <i class="bi bi-house"></i> Accueil
            </a>
        </div>
    </div>

    <!-- Messages de succès/erreur -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Sélecteur de date -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" th:action="@{/tableau_de_bord/statistiques}" class="row align-items-end">
                <div class="col-md-3">
                    <label for="date" class="form-label">Date des statistiques :</label>
                    <input type="date" class="form-control" id="date" name="date" 
                           th:value="${date}" required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Afficher
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" 
                            onclick="document.getElementById('date').value = '[[${aujourdhui}]]'">
                        <i class="bi bi-calendar-today"></i> Aujourd'hui
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <form th:action="@{/tableau_de_bord/mettre-a-jour}" method="post" style="display: inline;">
                        <input type="hidden" name="date" th:value="${date}">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-clockwise"></i> Mettre à jour
                        </button>
                    </form>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div th:if="${stats != null}" class="row mb-4">
        <div class="col-md-2">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-book text-primary" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-primary" th:text="${stats.nombrePrets}">0</h4>
                    <p class="card-text">Prêts</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-return-left text-success" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-success" th:text="${stats.nombreRetours}">0</h4>
                    <p class="card-text">Retours</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-info" th:text="${stats.nombreReservations}">0</h4>
                    <p class="card-text">Réservations</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-warning" th:text="${stats.nombrePenalites}">0</h4>
                    <p class="card-text">Pénalités</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-people text-secondary" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-secondary" th:text="${stats.nombreAdherentsActifs}">0</h4>
                    <p class="card-text">Adhérents actifs</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-dark">
                <div class="card-body text-center">
                    <i class="bi bi-collection text-dark" style="font-size: 2rem;"></i>
                    <h4 class="card-title text-dark" th:text="${stats.nombreLivresDisponibles}">0</h4>
                    <p class="card-text">Livres disponibles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> Activité des 7 derniers jours
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart"></i> Répartition de l'activité
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau détaillé -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-table"></i> Détails des statistiques
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Métrique</th>
                            <th>Valeur</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><i class="bi bi-book text-primary"></i> Prêts</td>
                            <td><span class="badge bg-primary" th:text="${stats.nombrePrets}">0</span></td>
                            <td>Nombre de prêts effectués ce jour</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-arrow-return-left text-success"></i> Retours</td>
                            <td><span class="badge bg-success" th:text="${stats.nombreRetours}">0</span></td>
                            <td>Nombre de retours effectués ce jour</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-calendar-check text-info"></i> Réservations</td>
                            <td><span class="badge bg-info" th:text="${stats.nombreReservations}">0</span></td>
                            <td>Nombre de réservations créées ce jour</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-exclamation-triangle text-warning"></i> Pénalités</td>
                            <td><span class="badge bg-warning" th:text="${stats.nombrePenalites}">0</span></td>
                            <td>Nombre de pénalités créées ce jour</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-people text-secondary"></i> Adhérents actifs</td>
                            <td><span class="badge bg-secondary" th:text="${stats.nombreAdherentsActifs}">0</span></td>
                            <td>Nombre total d'adhérents actifs</td>
                        </tr>
                        <tr>
                            <td><i class="bi bi-collection text-dark"></i> Livres disponibles</td>
                            <td><span class="badge bg-dark" th:text="${stats.nombreLivresDisponibles}">0</span></td>
                            <td>Nombre d'exemplaires disponibles</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
// Données pour les graphiques
const stats7Jours = /*[[${stats7Jours}]]*/ [];
const currentStats = /*[[${stats}]]*/ {};

// Graphique d'activité des 7 derniers jours
if (stats7Jours && stats7Jours.length > 0) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    const labels = stats7Jours.map(stat => stat.dateStat).reverse();
    const pretsData = stats7Jours.map(stat => stat.nombrePrets).reverse();
    const retoursData = stats7Jours.map(stat => stat.nombreRetours).reverse();
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Prêts',
                data: pretsData,
                borderColor: 'rgb(13, 110, 253)',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.1
            }, {
                label: 'Retours',
                data: retoursData,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Évolution sur 7 jours'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Graphique en camembert pour la répartition
if (currentStats) {
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Prêts', 'Retours', 'Réservations', 'Pénalités'],
            datasets: [{
                data: [
                    currentStats.nombrePrets || 0,
                    currentStats.nombreRetours || 0,
                    currentStats.nombreReservations || 0,
                    currentStats.nombrePenalites || 0
                ],
                backgroundColor: [
                    'rgba(13, 110, 253, 0.8)',
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(13, 202, 240, 0.8)',
                    'rgba(255, 193, 7, 0.8)'
                ],
                borderColor: [
                    'rgba(13, 110, 253, 1)',
                    'rgba(25, 135, 84, 1)',
                    'rgba(13, 202, 240, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Répartition de l\'activité'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
</body>
</html> 